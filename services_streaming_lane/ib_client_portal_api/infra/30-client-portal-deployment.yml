apiVersion: apps/v1
kind: Deployment
metadata:
  name: client-portal
  namespace: client-portal-api
  labels:
    app: client-portal
spec:
  replicas: 2
  selector:
    matchLabels:
      app: client-portal
  template:
    metadata:
      labels:
        app: client-portal
    spec:
      containers:
        - name: client-portal
          image: client-portal:1.0.0
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 5000
            - name: ws
              containerPort: 5001
          env:
            # ensure vert.x cache is writable (also set in Dockerfile; harmless to repeat)
            - name: JAVA_TOOL_OPTIONS
              value: "-Dvertx.cacheDirBase=/opt/clientportal.gw/resources/.vertx"
          volumeMounts:
            - name: resources
              mountPath: /opt/clientportal.gw/resources
          # ---- Option 1: exec probe against localhost:5000
          readinessProbe:
            exec:
              command: ["bash","-lc","exec 3<>/dev/tcp/127.0.0.1/5000"]
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 12
          livenessProbe:
            exec:
              command: ["bash","-lc","exec 3<>/dev/tcp/127.0.0.1/5000"]
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 3
            failureThreshold: 6
      volumes:
        - name: resources
          emptyDir: {}
