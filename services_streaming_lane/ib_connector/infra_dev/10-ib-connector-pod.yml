apiVersion: v1
kind: Pod
metadata:
  name: ib-connector
  namespace: ${NAMESPACE_IB}
spec:
  serviceAccountName: ib-connector
  imagePullSecrets:
    - name: dockerhub-pull
  containers:
    - name: ib-connector
      image: commodore95/quant_data_platform_repository:ib-connector-dev
      workingDir: /work
      # We use a literal block (|) to ensure the shell string is preserved exactly
      command: ["/bin/bash", "-lc"]
      args: 
        - |
          /usr/local/bin/ibkr-entrypoint.sh
          echo "[Launcher] Waiting 30s for system stability..."
          sleep 60
          echo "[Launcher] Shifting to /work and starting IbConnector..."
          cd /work && sbt -batch "runMain src.main.scala.IbConnector"
      envFrom:
        - secretRef:
            name: ibkr-secret
      env:
        - name: KAFKA_BOOTSTRAP_SERVERS
          value: "${KAFKA_NAME}-kafka-bootstrap.${NAMESPACE_KAFKA}:9092"
        - name: SCHEMA_REGISTRY_URL
          value: "http://schema-registry.avro-schema-registry:8081"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
  restartPolicy: Always