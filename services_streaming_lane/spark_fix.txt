export ROOT="$(cd "$(pwd)/.." && pwd)"

export SPARK_VERSION="3.5.7"
export SPARK_HOME="${ROOT}/services_streaming_lane/spark-${SPARK_VERSION}-bin-hadoop3"

export DOCKERHUB_REPO="commodore95/quant_data_platform_repository"
export SPARK_IMAGE_TAG="spark-our-own-apache-spark-kb8"
export APP_IMAGE_TAG="${SPARK_IMAGE_TAG}-app"
export SPARK_IMAGE_ADDRESS="${DOCKERHUB_REPO}:${APP_IMAGE_TAG}"

export NAMESPACE_SPARK="spark"
export SPARK_SA="spark-sa"

export SPARK_APP_CLASS="com.yourorg.spark.ReadTickLastPrint"

export SPARK_DRIVER_POD_TMPL="${ROOT}/services_streaming_lane/spark_processor/infra_dev/20-driver-pod-template.yml"
export SPARK_EXEC_POD_TMPL="${ROOT}/services_streaming_lane/spark_processor/infra_dev/21-executor-pod-template.yml"
export SPARK_DEFAULTS_FILE="${ROOT}/services_streaming_lane/spark_processor/infra_dev/30-spark-defaults.conf"

export APP_JAR_PATH_IN_IMAGE="/opt/spark/app/app.jar"

NS="spark"
SA="spark-sa"

kubectl -n "${NS}" create token "${SA}" > /tmp/spark-sa.token

SERVER="$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')"
CA="$(kubectl config view --raw --minify -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')"

cat > /tmp/spark-submit.kubeconfig <<EOF
apiVersion: v1
kind: Config
clusters:
- name: k3s
  cluster:
    server: ${SERVER}
    certificate-authority-data: ${CA}
users:
- name: spark-submit
  user:
    token: $(cat /tmp/spark-sa.token)
contexts:
- name: spark-submit@k3s
  context:
    cluster: k3s
    user: spark-submit
    namespace: ${NS}
current-context: spark-submit@k3s
EOF

unset KUBECONFIG
export KUBECONFIG="/tmp/spark-submit.kubeconfig"

NS="spark"
SA="spark-sa"
CTX="spark-submit@k3s"
SERVER="$(kubectl config view --raw --kubeconfig "${KUBECONFIG}" --minify -o jsonpath='{.clusters[0].cluster.server}')"

"${SPARK_HOME}/bin/spark-submit" \
	--master "k8s://${SERVER}" \
	--deploy-mode cluster \
	--name spark-app \
	--class "${SPARK_APP_CLASS}" \
	--conf "spark.kubernetes.namespace=${NS}" \
	--conf "spark.kubernetes.authenticate.submission.kubeconfigFile=${KUBECONFIG}" \
	--conf "spark.kubernetes.authenticate.submission.context=${CTX}" \
	--conf "spark.kubernetes.authenticate.driver.serviceAccountName=${SA}" \
	--conf "spark.kubernetes.container.image=${SPARK_IMAGE_ADDRESS}" \
	--conf "spark.kubernetes.container.image.pullPolicy=IfNotPresent" \
	--conf "spark.kubernetes.driver.podTemplateFile=${SPARK_DRIVER_POD_TMPL}" \
	--conf "spark.kubernetes.executor.podTemplateFile=${SPARK_EXEC_POD_TMPL}" \
	--properties-file "${SPARK_DEFAULTS_FILE}" \
	"local://${APP_JAR_PATH_IN_IMAGE}"
