// Use DBML to define your database structure
// Docs: https://dbml.dbdiagram.io/docs

Table trading_symbol {
  code symbol unique [not null]
  commodity symbol [not null]
  contract_description varchar [not null]
  contract_size float [not null]
  tick_size float [not null]
  trading_hours varchar [not null]
  exchange symbol [not null]
  point_value float [not null]
}
// physical table
// partition: none (tiny); primary index: code
// secondary index: exchange (logical)

Table market_order_levels {
  ingestion_time timestamp         // meta only
  event_time     timestamp [not null] // DESIGNATED TS
  trading_symbol symbol   [not null]
  source         symbol   [not null]  // 'IB', etc.
  side           symbol   [not null]  // 'bid' | 'ask'
  level          int      [not null]  // 0 = top of book
  price          double   [not null]
  size           long     [not null]
  event_id       uuid
}
// physical ingestion table
// PARTITION BY: (trading_symbol, toStartOfWeek(event_time))
// ORDER BY: (trading_symbol, event_time, side, level)
// INDEX: event_time (minmax)

Table market_trades {
  ingestion_time timestamp         // meta only
  event_time     timestamp [not null]
  trading_symbol symbol   [not null]
  source         symbol   [not null]
  price          double   [not null]
  size           long     [not null]
  event_id       uuid
}
// physical ingestion table
// PARTITION BY: (trading_symbol, toStartOfWeek(event_time))
// ORDER BY: (trading_symbol, event_time)
// INDEX: event_time (minmax)

Table market_trades_latest {
  ingestion_time timestamp
  event_time     timestamp [not null]
  trading_symbol symbol   [not null]
  source         symbol   [not null]
  price          double   [not null]
  size           long     [not null]
  event_id       uuid
}
// materialized view target (current-only)
// ENGINE: ReplacingMergeTree(version = event_time)
// PARTITION BY: (trading_symbol, toStartOfWeek(event_time))
// ORDER BY: (trading_symbol)
// INDEX: event_time (minmax)
// exactly one latest row per trading_symbol

Table book_latest {
  ingestion_time timestamp
  event_time     timestamp [not null]
  trading_symbol symbol   [not null]
  side           symbol   [not null]  // 'bid' | 'ask'
  level          int      [not null]
  price          double   [not null]
  size           long     [not null]
  event_id       uuid
}
// materialized view target (current-only)
// ENGINE: ReplacingMergeTree(version = event_time)
// PARTITION BY: (trading_symbol, toStartOfWeek(event_time))
// ORDER BY: (trading_symbol, side, level)
// INDEX: event_time (minmax)
// one latest row per (trading_symbol, side, level)

Table bars_1s {
  trading_symbol  symbol    [not null]
  open            double    [not null]
  high            double    [not null]
  low             double    [not null]
  close           double    [not null]
  volume          long      [not null]
  bar_start_time  timestamp [not null]
  bar_end_time    timestamp [not null]
}
// materialized view target from market_trades
// PARTITION BY: (trading_symbol, toStartOfWeek(bar_start_time))
// ORDER BY: (trading_symbol, bar_start_time)
// INDEX: bar_start_time (minmax)

Table bars_1m {
  trading_symbol  symbol    [not null]
  open            double    [not null]
  high            double    [not null]
  low             double    [not null]
  close           double    [not null]
  volume          long      [not null]
  bar_start_time  timestamp [not null]
  bar_end_time    timestamp [not null]
}
// materialized view target from bars_1s
// PARTITION BY: (trading_symbol, toStartOfWeek(bar_start_time))
// ORDER BY: (trading_symbol, bar_start_time)
// INDEX: bar_start_time (minmax)

Table bars_1h {
  trading_symbol  symbol    [not null]
  open            double    [not null]
  high            double    [not null]
  low             double    [not null]
  close           double    [not null]
  volume          long      [not null]
  bar_start_time  timestamp [not null]
  bar_end_time    timestamp [not null]
}
// materialized view target from bars_1m
// PARTITION BY: (trading_symbol, toStartOfWeek(bar_start_time))
// ORDER BY: (trading_symbol, bar_start_time)
// INDEX: bar_start_time (minmax)

Ref: market_trades.trading_symbol - trading_symbol.code
Ref: market_order_levels.trading_symbol - trading_symbol.code
Ref: book_latest.trading_symbol - trading_symbol.code 
Ref: bars_1s.trading_symbol - trading_symbol.code 
Ref: bars_1m.trading_symbol - trading_symbol.code
Ref: bars_1h.trading_symbol - trading_symbol.code
Ref: market_trades_latest.trading_symbol - trading_symbol.code
