// Note that for the physical design we will partition by source system and the designated timestamp by month in fabric
// on clickhouse only partition by source_system since we will run the pipeline only for 3h at most
// the 'glossar' defines the possible values for all enum datatypes and is defined in the control plane
// all timestamps are in ISO 8601:2004 and UTC+0

Table derivatives_tick_market_data {
  source_system_name enum [not null] 
  component_instance_name enum [not null]
  ingestion_time timestamp [not null]               // connector → buffer
  ingestion_time_realtime_store timestamp [not null]// buffer → CH
  exchange_code enum [not null]
  symbol_code enum [not null]
  symbol_type enum [not null]
  price double [not null]
  price_unit enum [not null]
  size double [not null]
  size_unit enum [not null]
  tick_time timestamp [not null]
  open_interest int
  open_interest_unit enum

  Indexes {
    (source_system_name, symbol_code, tick_time) [pk, unique]
  }
}

Table derivatives_l2_market_data {
  source_system_name enum [not null]
  component_instance_name enum [not null]
  ingestion_time timestamp [not null]
  ingestion_time_realtime_store timestamp [not null]
  exchange_code enum [not null]
  symbol_code enum [not null]
  symbol_type enum [not null]
  price double [not null]
  price_unit enum [not null]
  side enum [not null]
  level int [not null]
  max_level int [not null]
  l2_time timestamp [not null]
  open_interest long
  open_interest_unit enum

  Indexes {
    (source_system_name, symbol_code, l2_time) [pk, unique]
  }
}

Table indicators_market_data {
  source_system_name enum [not null]
  component_instance_name enum [not null]
  ingestion_time timestamp [not null]
  ingestion_time_realtime_store timestamp [not null]
  market_event_time timestamp [not null]
  symbol_code enum [not null]
  indicator_scope enum [not null] // 'tick','l2','release'
  indicator_name string [not null]
  indicator_value double [not null]
  indicator_value_unit enum [not null]
}

Table market_trades_latest {
  source_system_name enum [not null]
  ingestion_time timestamp [not null]
  tick_time timestamp
  symbol_code enum [not null]
  price double [not null]
  price_unit enum [not null]
  size long [not null]
  size_unit enum [not null]

  Indexes {
    (source_system_name, symbol_code, tick_time) [pk, unique]
  }
}

Table book_latest {
  source_system_name enum [not null]
  ingestion_time timestamp [not null]
  symbol_code enum [not null]
  side symbol [not null]
  level long [not null]
  max_level long [not null]
  price double [not null]
  price_unit enum [not null]
  size long [not null]
  size_unit enum [not null]
  open_interest long
  open_interest_unit enum

  Indexes {
    (source_system_name, symbol_code, ingestion_time_realtime_store) [pk, unique]
  }
}

Table bars_1s {
  source_system_name enum [not null]
  ingestion_time timestamp [not null]
  symbol_code enum [not null]
  open double [not null]
  high double [not null]
  low double [not null]
  close double [not null]
  volume long [not null]
  bar_start_time timestamp [not null]
  bar_end_time timestamp [not null]
  open_interest long
  open_interest_unit enum

  Indexes {
    (source_system_name, symbol_code, bar_end_time) [pk, unique]
  }
}

Table bars_1m {
  source_system_name enum [not null]
  ingestion_time timestamp [not null]
  ingestion_time_realtime_store timestamp [not null]
  symbol_code enum [not null]
  open double [not null]
  high double [not null]
  low double [not null]
  close double [not null]
  volume long [not null]
  bar_start_time timestamp [not null]
  bar_end_time timestamp [not null]
  open_interest long
  open_interest_unit enum

  Indexes {
    (source_system_name, symbol_code, bar_end_time) [pk, unique]
  }
}

Table bars_1h {
  source_system_name enum [not null]
  ingestion_time timestamp [not null]
  ingestion_time_realtime_store timestamp [not null]
  symbol_code enum [not null]
  open double [not null]
  high double [not null]
  low double [not null]
  close double [not null]
  volume long [not null]
  bar_start_time timestamp [not null]
  bar_end_time timestamp [not null]
  open_interest long
  open_interest_unit enum

  Indexes {
    (source_system_name, symbol_code, bar_end_time) [pk, unique]
  }
}

// Example denormalized twin: tick data with indicators flattened
Table derivatives_tick_market_data_indicators {
  source_system_name enum [not null]
  component_instance_name enum [not null]
  ingestion_time timestamp [not null]
  ingestion_time_realtime_store timestamp [not null]
  exchange_code enum [not null]
  symbol_code enum [not null]
  symbol_type enum [not null]
  price double [not null]
  price_unit enum [not null]
  size double [not null]
  size_unit enum [not null]
  tick_time timestamp [not null]
  open_interest int
  open_interest_unit enum

  -- indicator columns from source at same (source,symbol,tick_time):
  indicator_scope enum [not null] // 'tick'
  indicator_name string [not null]
  indicator_value double [not null]
  indicator_value_unit enum [not null]

  Indexes {
    (source_system_name, symbol_code, tick_time, indicator_name) [pk, unique]
  }

  Note: 'Materialized join of derivatives_tick_market_data + indicators_market_data where indicator_scope = tick.'
}

// References
Ref: derivatives_l2_market_data.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: indicators_market_data.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: market_trades_latest.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: book_latest.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: bars_1s.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: bars_1m.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: bars_1h.(source_system_name, symbol_code) > derivatives_tick_market_data.(source_system_name, symbol_code)
Ref: derivatives_tick_market_data_indicators.(source_system_name, symbol_code, tick_time) > derivatives_tick_market_data.(source_system_name, symbol_code, tick_time)

// indicators.market_event_time refers to either tick_time or l2_time
Ref: indicators_market_data.(source_system_name, symbol_code, market_event_time) > derivatives_tick_market_data.(source_system_name, symbol_code, tick_time)
Ref: indicators_market_data.(source_system_name, symbol_code, market_event_time) > derivatives_l2_market_data.(source_system_name, symbol_code, l2_time)
